
DROP TABLE IF EXISTS Aluno_Disciplina;
DROP TABLE IF EXISTS Pre_Requisito;
DROP TABLE IF EXISTS Avaliacao;
DROP TABLE IF EXISTS Professor_Contato;
DROP TABLE IF EXISTS Disciplina;

IF EXISTS (SELECT * FROM sys.foreign_keys WHERE name = 'fk_chefe')
    ALTER TABLE Departamento DROP CONSTRAINT fk_chefe;

DROP TABLE IF EXISTS Professor;
DROP TABLE IF EXISTS Departamento;
DROP TABLE IF EXISTS Aluno;
GO

CREATE TABLE Departamento (
    id INT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    local VARCHAR(255),
    id_professor_chefe VARCHAR(14)
);

CREATE TABLE Professor (
    cpf VARCHAR(14) PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    inicio_contrato DATE,
    id_depto INT FOREIGN KEY REFERENCES Departamento(id)
);

ALTER TABLE Departamento
ADD CONSTRAINT fk_chefe
FOREIGN KEY (id_professor_chefe) REFERENCES Professor(cpf);

CREATE TABLE Disciplina (
    id_disciplina INT IDENTITY(1,1) PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    carga_horaria INT,
    cpf_professor VARCHAR(14) FOREIGN KEY REFERENCES Professor(cpf)
);

CREATE TABLE Aluno (
    matricula VARCHAR(20) PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    data_nascimento DATE,
    endereco VARCHAR(255)
);

CREATE TABLE Aluno_Disciplina (
    matricula_aluno VARCHAR(20),
    id_disciplina INT,
    PRIMARY KEY (matricula_aluno, id_disciplina),
    FOREIGN KEY (matricula_aluno) REFERENCES Aluno(matricula),
    FOREIGN KEY (id_disciplina) REFERENCES Disciplina(id_disciplina)
);
GO

INSERT INTO Departamento (id, nome, local) VALUES
(1, 'Exatas e Tecnologia', 'Bloco A - Andar 2'),
(2, 'Ciências Biológicas', 'Bloco B - Andar 1'),
(3, 'Ciências Humanas', 'Bloco C - Térreo');

INSERT INTO Professor (cpf, nome, inicio_contrato, id_depto) VALUES
('111.111.111-11', 'Alan Turing', '2010-03-15', 1),
('222.222.222-22', 'Ada Lovelace', '2012-05-20', 1),
('333.333.333-33', 'Charles Darwin', '2015-08-10', 2),
('444.444.444-44', 'Marie Curie', '2018-02-01', 2),
('555.555.555-55', 'Hannah Arendt', '2014-11-30', 3);

UPDATE Departamento SET id_professor_chefe = '111.111.111-11' WHERE id = 1;
UPDATE Departamento SET id_professor_chefe = '444.444.444-44' WHERE id = 2;
UPDATE Departamento SET id_professor_chefe = '555.555.555-55' WHERE id = 3;

INSERT INTO Aluno (matricula, nome, data_nascimento, endereco) VALUES
('MAT001', 'João Silva', '2001-01-10', 'Rua das Flores, 10'),
('MAT002', 'Maria Oliveira', '1999-12-05', 'Av. Central, 500'),
('MAT003', 'Carlos Souza', '2002-03-22', 'Rua Bahia, 12'),
('MAT004', 'Ana Costa', '2000-07-14', 'Travessa da Paz, 5'),
('MAT005', 'Pedro Santos', '2003-09-30', 'Rua de Trás, 99');

INSERT INTO Disciplina (nome, carga_horaria, cpf_professor) VALUES
('Algoritmos', 80, '111.111.111-11'),
('Cálculo I', 60, '222.222.222-22'),
('Genética', 40, '333.333.333-33'),
('Física Nuclear', 60, '444.444.444-44'),
('Filosofia Política', 40, '555.555.555-55');

INSERT INTO Aluno_Disciplina VALUES
('MAT001', 1),
('MAT001', 2),
('MAT002', 1),
('MAT002', 5),
('MAT003', 3),
('MAT004', 4),
('MAT005', 2),
('MAT005', 5);
GO

CREATE VIEW VW_Dados_Completos_Aluno AS
SELECT
    A.matricula,
    A.nome AS nome_aluno,
    A.data_nascimento,
    A.endereco,
    D.nome AS disciplina,
    D.carga_horaria,
    P.nome AS professor,
    DEP.nome AS departamento
FROM Aluno A
LEFT JOIN Aluno_Disciplina AD ON A.matricula = AD.matricula_aluno
LEFT JOIN Disciplina D ON AD.id_disciplina = D.id_disciplina
LEFT JOIN Professor P ON D.cpf_professor = P.cpf
LEFT JOIN Departamento DEP ON P.id_depto = DEP.id;
GO

CREATE PROCEDURE BuscarAlunoCompleto
    @matricula VARCHAR(20) = NULL,
    @nome VARCHAR(100) = NULL
AS
BEGIN
    SELECT *
    FROM VW_Dados_Completos_Aluno
    WHERE (@matricula IS NULL OR matricula = @matricula)
      AND (@nome IS NULL OR nome_aluno = @nome);
END;
GO
